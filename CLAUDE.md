# ColocApp - Gestion des depenses en colocation

## Consignes de developpement

- **Aucune signature LLM dans les commits** : ne pas inclure de mention "Co-Authored-By", "Generated by", ou toute reference a un LLM/IA dans les messages de commit ou le code
- Langue du projet : francais pour la documentation, anglais pour le code
- Toujours tester les migrations up ET down avant de commit
- Code lisible > code "intelligent" : privilegier la clarte, noms explicites, et une simplicite assumee plutot que des astuces difficiles a maintenir
- Une fonction = une responsabilite : extraire les verifications partagées ou les traitements annexes dans des helpers prives pour garder chaque fonction courte et previsible
- Aucune logique metier dans les handlers gRPC/HTTP : ils ne font que valider les inputs, appeler les services et mapper les reponses
- Pas de nombres magiques : declarer des constantes nommees (ex: `defaultTolerance = 0.01`) pour toute valeur fixe utilisee dans le code afin d'eviter les ambiguïtés

## Fonctionnalites

### Principales
1. **Authentification** - Inscription, connexion, JWT, gestion de session
2. **Gestion de colocation** - Creation, invitation par code, roles (admin/membre), suppression de membres
3. **Depenses** - Ajout, modification, suppression avec 3 modes de partage :
   - Egal (divise entre tous)
   - Pourcentage (chacun declare un %)
   - Personnalise (montants fixes par personne)
4. **Depenses recurrentes** - Templates de depenses avec generation automatique (quotidien, hebdo, mensuel, annuel)
5. **Previsionnels** - Estimation des depenses futures par mois et par categorie
6. **Soldes et dettes** - Calcul automatique de qui doit combien a qui, avec algorithme de simplification des dettes (min-cash-flow)
7. **Paiements** - Declaration de remboursement avec confirmation par le destinataire
8. **Categories de depenses** - Categories globales (Loyer, Courses, Electricite, etc.) + categories personnalisees par coloc
9. **Decisions collectives** - Systeme de vote avec options multiples, anonymat, deadline
10. **Fonds communs** - Cagnottes avec objectif, contributions, suivi du montant
11. **Evenements** - Creation d'evenements lies a un fond commun, RSVP des participants
12. **Notifications** - Notifications temps reel via streaming gRPC (nouvelle depense, paiement recu, invitation, etc.)

### Optionnelles
- **LLM** - Ajout de depenses en langage naturel (ex: "j'ai paye 230EUR de courses Carrefour hier, a partager entre nous")

## Technologies

### Backend
| Composant | Technologie |
|---|---|
| Langage | Go 1.25+ |
| API | gRPC + grpc-gateway (REST sur port 8080) |
| Base de donnees | PostgreSQL 16 |
| Driver SQL | pgx/v5 (jackc/pgx) |
| Migrations | golang-migrate |
| Authentification | golang-jwt/v5 + bcrypt |
| Protobuf | protoc + protoc-gen-go + protoc-gen-grpc-gateway |
| Infrastructure | Docker + Docker Compose |
| Configuration | Variables d'environnement |

### Frontend
| Composant | Technologie |
|---|---|
| Framework | React 18 + TypeScript |
| Style | Tailwind CSS |
| Graphiques | Recharts |
| Routing | React Router v6 |
| HTTP | Axios |
| State | React Context + hooks |
| Build | Vite |

### Design
- Theme blanc (#FFFFFF), cartes avec ombres legeres
- Accents bleu (#5682F2) et orange dore (#F1C086)
- Sidebar navigation + contenu principal en grille de cartes
- Style dashboard inspire de Finary
- Typo : Inter

## Schema BDD

```
┌──────────────────┐
│      users       │
├──────────────────┤
│ id (UUID, PK)    │
│ email (UNIQUE)   │
│ password_hash    │
│ nom              │
│ prenom           │
│ telephone        │
│ avatar_url       │
│ is_active        │
│ created_at       │
│ updated_at       │
└──────┬───────────┘
       │
       │ 1..*
       ▼
┌──────────────────────┐      ┌──────────────────┐
│ colocation_members   │──────│   colocations    │
├──────────────────────┤      ├──────────────────┤
│ id (UUID, PK)        │      │ id (UUID, PK)    │
│ colocation_id (FK)   │      │ name             │
│ user_id (FK)         │      │ description      │
│ role (admin/member)  │      │ address          │
│ joined_at            │      │ created_by (FK)  │
└──────────────────────┘      │ invite_code      │
                              │ created_at       │
┌──────────────────────┐      │ updated_at       │
│colocation_invitations│      └──────────────────┘
├──────────────────────┤             │
│ id (UUID, PK)        │             │ 1..*
│ colocation_id (FK)   │             ▼
│ invited_by (FK)      │      ┌──────────────────────┐
│ invited_email        │      │ expense_categories   │
│ status               │      ├──────────────────────┤
│ expires_at           │      │ id (UUID, PK)        │
│ created_at           │      │ name                 │
└──────────────────────┘      │ icon                 │
                              │ color                │
                              │ colocation_id (FK)   │ -- NULL = globale
                              └──────────────────────┘
                                       │
                                       ▼
┌──────────────────────┐      ┌──────────────────────┐
│   expense_splits     │──────│      expenses        │
├──────────────────────┤      ├──────────────────────┤
│ id (UUID, PK)        │      │ id (UUID, PK)        │
│ expense_id (FK)      │      │ colocation_id (FK)   │
│ user_id (FK)         │      │ paid_by (FK)         │
│ amount               │      │ category_id (FK)     │
│ percentage           │      │ title                │
│ is_settled           │      │ description          │
│                      │      │ amount               │
└──────────────────────┘      │ split_type           │
                              │ expense_date         │
                              │ recurring_id (FK)    │
                              │ created_at           │
                              └──────────────────────┘

┌──────────────────────────┐  ┌──────────────────────────┐
│   recurring_expenses     │  │ recurring_expense_splits  │
├──────────────────────────┤  ├──────────────────────────┤
│ id (UUID, PK)            │  │ id (UUID, PK)            │
│ colocation_id (FK)       │  │ recurring_id (FK)        │
│ paid_by (FK)             │  │ user_id (FK)             │
│ category_id (FK)         │  │ percentage               │
│ title, amount            │  └──────────────────────────┘
│ split_type, recurrence   │
│ next_due_date, end_date  │
│ is_active                │
└──────────────────────────┘

┌──────────────────────┐      ┌──────────────────────┐
│      balances        │      │      payments        │
├──────────────────────┤      ├──────────────────────┤
│ id (UUID, PK)        │      │ id (UUID, PK)        │
│ colocation_id (FK)   │      │ colocation_id (FK)   │
│ from_user_id (FK)    │      │ from_user_id (FK)    │
│ to_user_id (FK)      │      │ to_user_id (FK)      │
│ amount               │      │ amount               │
│ updated_at           │      │ status               │
└──────────────────────┘      │ note                 │
                              │ confirmed_at         │
                              │ created_at           │
                              └──────────────────────┘

┌──────────────────────┐      ┌──────────────────────┐
│     decisions        │      │   decision_votes     │
├──────────────────────┤      ├──────────────────────┤
│ id (UUID, PK)        │      │ id (UUID, PK)        │
│ colocation_id (FK)   │      │ decision_id (FK)     │
│ created_by (FK)      │      │ user_id (FK)         │
│ title, description   │      │ option_index         │
│ options (JSONB)      │      │ created_at           │
│ status               │      └──────────────────────┘
│ deadline             │
│ allow_multiple       │
│ is_anonymous         │
└──────────────────────┘

┌──────────────────────┐      ┌──────────────────────┐
│    common_funds      │      │  fund_contributions  │
├──────────────────────┤      ├──────────────────────┤
│ id (UUID, PK)        │      │ id (UUID, PK)        │
│ colocation_id (FK)   │      │ fund_id (FK)         │
│ name                 │      │ user_id (FK)         │
│ target_amount        │      │ amount               │
│ current_amount       │      │ note                 │
│ is_active            │      │ created_at           │
│ created_by (FK)      │      └──────────────────────┘
└──────────────────────┘

┌──────────────────────┐      ┌──────────────────────┐
│       events         │      │ event_participants   │
├──────────────────────┤      ├──────────────────────┤
│ id (UUID, PK)        │      │ id (UUID, PK)        │
│ colocation_id (FK)   │      │ event_id (FK)        │
│ fund_id (FK)         │      │ user_id (FK)         │
│ created_by (FK)      │      │ rsvp                 │
│ title, description   │      │ created_at           │
│ budget, event_date   │      └──────────────────────┘
│ location, status     │
└──────────────────────┘

┌──────────────────────┐
│    notifications     │
├──────────────────────┤
│ id (UUID, PK)        │
│ user_id (FK)         │
│ colocation_id (FK)   │
│ type                 │
│ title, body          │
│ data (JSONB)         │
│ is_read              │
│ created_at           │
└──────────────────────┘
```

## Structure du projet

```
Renforcement-Backend/
├── cmd/server/main.go              # Point d'entree (gRPC:50051 + REST:8080)
├── proto/                          # Definitions protobuf
│   ├── common.proto
│   ├── auth.proto
│   ├── user.proto
│   ├── colocation.proto
│   ├── expense.proto
│   ├── balance.proto
│   ├── payment.proto
│   ├── category.proto
│   ├── decision.proto
│   ├── fund.proto
│   ├── notification.proto
│   └── pb/                         # Code Go genere
├── internal/
│   ├── config/                     # Configuration (env vars)
│   ├── constants/                  # Constantes nommees (pagination, tolerances, etc.)
│   ├── domain/                     # Modeles + interfaces repository
│   ├── repository/postgres/        # Implementation PostgreSQL
│   ├── service/                    # Logique metier
│   ├── grpc/                       # Handlers gRPC
│   ├── auth/                       # JWT, bcrypt, interceptor
│   └── algorithm/                  # Simplification des dettes
├── migrations/                     # Fichiers SQL (golang-migrate)
├── frontend/                       # React + Tailwind
│   ├── src/
│   │   ├── api/                    # Appels REST vers la gateway
│   │   ├── components/             # Composants React
│   │   ├── pages/                  # Pages du dashboard
│   │   ├── hooks/                  # Hooks personnalises
│   │   ├── context/                # Auth, Notifications
│   │   ├── types/                  # Types TypeScript
│   │   └── utils/                  # Formatage, helpers
│   ├── tailwind.config.js
│   └── package.json
├── docker-compose.yml
├── Dockerfile
├── Makefile
└── go.mod
```

## Commandes

```bash
# Infrastructure
docker compose up -d                # Lancer PostgreSQL
docker compose down                 # Arreter

# Migrations
make migrate-up                     # Appliquer les migrations
make migrate-down                   # Rollback d'une migration

# Protobuf
make proto                          # Generer le code Go depuis les .proto

# Backend
make run                            # Lancer gRPC (50051) + REST gateway (8080)
make build                          # Compiler le binaire

# Frontend
cd frontend && npm run dev          # Lancer le dev server (5173)
cd frontend && npm run build        # Build production
```

## Variables d'environnement

| Variable | Defaut | Description |
|---|---|---|
| DB_HOST | localhost | Hote PostgreSQL |
| DB_PORT | 5432 | Port PostgreSQL |
| DB_USER | coloc_user | Utilisateur BDD |
| DB_PASSWORD | coloc_password | Mot de passe BDD |
| DB_NAME | coloc_db | Nom de la base |
| DB_SSLMODE | disable | Mode SSL |
| GRPC_PORT | 50051 | Port du serveur gRPC |
| HTTP_PORT | 8080 | Port de la gateway REST |
| JWT_SECRET | - | Cle secrete JWT |
| JWT_EXPIRY | 24h | Duree du token d'acces |
| REFRESH_TOKEN_EXPIRY | 168h | Duree du refresh token |
